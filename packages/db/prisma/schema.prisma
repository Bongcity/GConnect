// GConnect Database Schema
// Microsoft SQL Server 2022

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ============================================
// IR 사이트 - 문의 관리
// ============================================

/// IR 사이트에서 접수된 문의
model IRInquiry {
  id           Int      @id @default(autoincrement())
  
  // 기본 정보
  storeName    String   @db.NVarChar(200)
  email        String   @db.NVarChar(200)
  phone        String?  @db.NVarChar(50)
  
  // 문의 내용
  planIntent   String?  @db.NVarChar(50)  // STARTER, PRO, ENTERPRISE, UNKNOWN
  inquiryType  String   @db.NVarChar(50)  // ADOPTION, PRICING, TECH, OTHER
  message      String   @db.NVarChar(Max)
  
  // 메타데이터
  userAgent    String?  @db.NVarChar(500)
  referrer     String?  @db.NVarChar(500)
  pageUrl      String?  @db.NVarChar(500)
  
  // 처리 상태
  isHandled    Boolean  @default(false)
  handledAt    DateTime?
  handlerUserId String?
  
  // 타임스탬프
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // 관계
  responses    InquiryResponse[]
  
  @@map("IRInquiries")
}

// ============================================
// 인증 & 사용자 (NextAuth.js)
// ============================================

/// 사용자 정보
model User {
  id            String    @id @default(uuid())
  email         String    @unique @db.NVarChar(255)
  name          String?   @db.NVarChar(100)
  password      String?   @db.NVarChar(255) // 이메일 로그인용 (bcrypt 해시)
  emailVerified DateTime?
  image         String?   @db.NVarChar(500)
  
  // 네이버 연동 정보
  naverUserId   String?   @unique @db.NVarChar(100)
  naverEmail    String?   @db.NVarChar(255)
  
  // 상점 정보
  shopName      String?   @db.NVarChar(200)
  shopStatus    String    @default("PENDING") @db.NVarChar(50) // PENDING, ACTIVE, SUSPENDED
  naverShopUrl  String?   @db.NVarChar(500) // 네이버 스마트스토어 URL
  naverShopId   String?   @db.NVarChar(100) // 네이버 스마트스토어 ID
  businessNumber String?  @db.NVarChar(50)  // 사업자 번호 (선택)
  phone         String?   @db.NVarChar(50)  // 연락처
  
  // 네이버 커머스 API 설정
  naverClientId     String? @db.NVarChar(255) // 네이버 커머스 API 클라이언트 ID
  naverClientSecret String? @db.NVarChar(500) // 네이버 커머스 API 클라이언트 Secret (암호화)
  naverApiEnabled   Boolean @default(false)   // API 연동 활성화 여부
  
  // 타임스탬프
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // 관계
  accounts      Account[]
  sessions      Session[]
  products      Product[]
  syncLogs      SyncLog[]
  dailyAnalytics DailyAnalytics[]
  feedSettings  FeedSettings?
  syncSchedule  SyncSchedule?
  webhooks      Webhook[]
  subscriptions UserSubscription[]
  
  @@map("Users")
}

/// OAuth 계정 정보 (NextAuth)
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String  @db.NVarChar(50)
  provider          String  @db.NVarChar(50)
  providerAccountId String  @db.NVarChar(255)
  refresh_token     String? @db.NVarChar(Max)
  access_token      String? @db.NVarChar(Max)
  expires_at        Int?
  token_type        String? @db.NVarChar(50)
  scope             String? @db.NVarChar(500)
  id_token          String? @db.NVarChar(Max)
  session_state     String? @db.NVarChar(500)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("Accounts")
}

/// 세션 정보 (NextAuth)
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @db.NVarChar(500)
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("Sessions")
}

/// 이메일 인증 토큰 (NextAuth)
model VerificationToken {
  identifier String   @db.NVarChar(255)
  token      String   @unique @db.NVarChar(500)
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("VerificationTokens")
}

// ============================================
// 구독 & 플랜 관리
// ============================================

/// 구독 플랜 정의
model Plan {
  id              String   @id @default(uuid())
  
  // 플랜 정보
  name            String   @db.NVarChar(100) // Starter, Pro, Enterprise
  displayName     String   @db.NVarChar(100) // 표시용 이름
  description     String?  @db.NVarChar(500)
  
  // 제한 사항
  maxProducts     Int      // 최대 상품 수 (10000, 50000, 999999)
  maxApiCalls     Int?     // 월 API 호출 제한
  
  // 가격
  monthlyPrice    Int      // 월 구독료 (원)
  yearlyPrice     Int?     // 연 구독료 (원)
  
  // 기능 제한
  features        String?  @db.NVarChar(Max) // JSON: 사용 가능한 기능 목록
  
  // 상태
  isActive        Boolean  @default(true)
  isPublic        Boolean  @default(true) // 공개 플랜 여부
  sortOrder       Int      @default(0)    // 정렬 순서
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // 관계
  subscriptions   UserSubscription[]
  
  @@map("Plans")
}

/// 사용자 구독 정보
model UserSubscription {
  id              String   @id @default(uuid())
  userId          String
  planId          String
  
  // 구독 기간
  startDate       DateTime
  endDate         DateTime?
  
  // 상태
  status          String   @db.NVarChar(50) // ACTIVE, EXPIRED, CANCELLED, TRIAL
  
  // 결제 정보
  paymentMethod   String?  @db.NVarChar(50) // CARD, BANK, MANUAL
  paymentId       String?  @db.NVarChar(200) // 외부 결제 시스템 ID
  
  // 사용량 추적
  currentProducts Int      @default(0) // 현재 등록된 상품 수
  
  // 자동 갱신
  autoRenew       Boolean  @default(true)
  
  // 메모 (관리자용)
  adminNote       String?  @db.NVarChar(Max)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // 관계
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            Plan     @relation(fields: [planId], references: [id])
  payments        Payment[]
  
  @@index([userId])
  @@index([planId])
  @@index([status])
  @@map("UserSubscriptions")
}

/// 결제 내역
model Payment {
  id              String   @id @default(uuid())
  subscriptionId  String
  userId          String
  
  // 결제 정보
  amount          Int      // 결제 금액 (원)
  currency        String   @default("KRW") @db.NVarChar(10)
  method          String   @db.NVarChar(50) // CARD, BANK, MANUAL
  status          String   @db.NVarChar(50) // SUCCESS, FAILED, REFUNDED, PENDING
  
  // 외부 결제 시스템
  transactionId   String?  @db.NVarChar(200) // 외부 결제 ID
  paymentGateway  String?  @db.NVarChar(50)  // 결제 게이트웨이 (TOSS, NICE, etc)
  
  // 환불 정보
  refundReason    String?  @db.NVarChar(500)
  refundedAt      DateTime?
  refundedBy      String?  // 환불 처리한 관리자 ID
  
  // 메타데이터
  metadata        String?  @db.NVarChar(Max) // JSON
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // 관계
  subscription    UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("Payments")
}

// ============================================
// 상품 관리 (DDRo 기준 구조 적용)
// ============================================

/// SELLER 상품 정보 (GCONNECT에 가입한 파트너 스토어 상품)
/// ⚠️ DDRo의 affiliate_products 구조를 따라 설계됨
/// ⚠️ GCONNECT는 자동 증가 ID 사용 (DDRo는 수동 관리)
model Product {
  id                            BigInt    @id @default(autoincrement())
  userId                        String    // 상품 소유자 (User.id 참조)
  
  // 제휴 상점 정보 (DDRo와 동일한 구조)
  affiliate_store_id            BigInt?
  store_name                    String?   @db.NVarChar(200)
  brand_store                   Boolean?
  store_status                  String?   @db.NVarChar(50)
  
  // 상품 기본 정보
  product_name                  String?   @db.NVarChar(500)
  product_status                String?   @db.NVarChar(50)
  
  // 가격 정보
  sale_price                    BigInt?
  discounted_sale_price         BigInt?
  discounted_rate               Float?
  
  // 수수료 정보
  commission_rate               Float?
  promotion_commission_rate     Float?
  
  // 이미지 정보
  representative_product_image_url  String?   @db.NVarChar(1000)
  other_product_image_urls      String?   @db.NVarChar(Max)
  
  // URL 정보
  product_url                   String?   @db.NVarChar(1000)
  product_description_url       String?   @db.NVarChar(1000)
  affiliate_url                 String?   @db.NVarChar(1000)
  affiliate_url_id              BigInt?
  affiliate_url_updated_at      DateTime?
  
  // 프로모션 정보 (JSON)
  promotion_json                String?   @db.NVarChar(Max)
  
  // 상태
  enabled                       Boolean?  @default(true)
  
  // 수집 메타 정보
  source_keyword                String?   @db.NVarChar(200)
  source_cid                    String?   @db.NVarChar(50)
  source_rank                   Int?
  google_in                     Int?
  
  // 타임스탬프
  created_at                    DateTime? @default(now())
  updated_at                    DateTime? @default(now())
  
  // 관계
  user                          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([source_cid])
  @@index([source_keyword])
  @@index([created_at])
  @@map("affiliate_products")
}

/// 동기화 로그
model SyncLog {
  id          String   @id @default(uuid())
  userId      String
  syncType    String   @db.NVarChar(50) // PRODUCT_SYNC, MANUAL_SYNC
  status      String   @db.NVarChar(50) // SUCCESS, FAILED, PARTIAL
  itemsTotal  Int      @default(0)
  itemsSynced Int      @default(0)
  itemsFailed Int      @default(0)
  errorLog    String?  @db.NVarChar(Max)
  
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("SyncLogs")
}

/// 자동 동기화 스케줄
model SyncSchedule {
  id              String   @id @default(uuid())
  userId          String   @unique
  
  // 스케줄 설정
  isEnabled       Boolean  @default(false)
  cronExpression  String   @default("0 2 * * *") @db.NVarChar(50) // 기본: 매일 새벽 2시
  timezone        String   @default("Asia/Seoul") @db.NVarChar(50)
  
  // 옵션
  syncProducts    Boolean  @default(true)  // 상품 동기화
  updateFeed      Boolean  @default(true)  // 피드 업데이트
  
  // 알림 설정
  notifyOnSuccess Boolean  @default(false)
  notifyOnError   Boolean  @default(true)
  notifyEmail     String?  @db.NVarChar(255)
  
  // 통계
  lastRun         DateTime?
  lastStatus      String?  @db.NVarChar(50) // SUCCESS, FAILED
  nextRun         DateTime?
  totalRuns       Int      @default(0)
  successRuns     Int      @default(0)
  failedRuns      Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("SyncSchedules")
}

// ============================================
// 웹훅 시스템
// ============================================

/// 웹훅 설정
model Webhook {
  id              String   @id @default(uuid())
  userId          String
  
  // 웹훅 정보
  name            String   @db.NVarChar(100)
  url             String   @db.NVarChar(500)
  type            String   @db.NVarChar(50) // SLACK, DISCORD, CUSTOM
  isEnabled       Boolean  @default(true)
  
  // 트리거 설정
  triggerOnSuccess Boolean  @default(true)
  triggerOnError   Boolean  @default(true)
  
  // 인증 (선택)
  authType        String?  @db.NVarChar(50) // NONE, BEARER, BASIC
  authValue       String?  @db.NVarChar(500) // 암호화된 토큰/비밀번호
  
  // 커스텀 헤더 (JSON)
  customHeaders   String?  @db.NVarChar(Max)
  
  // 통계
  lastTriggered   DateTime?
  lastStatus      String?  @db.NVarChar(50) // SUCCESS, FAILED
  totalTriggers   Int      @default(0)
  successTriggers Int      @default(0)
  failedTriggers  Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs            WebhookLog[]
  
  @@index([userId])
  @@map("Webhooks")
}

/// 웹훅 실행 로그
model WebhookLog {
  id              String   @id @default(uuid())
  webhookId       String
  
  // 요청 정보
  requestUrl      String   @db.NVarChar(500)
  requestMethod   String   @db.NVarChar(10)
  requestBody     String?  @db.NVarChar(Max)
  requestHeaders  String?  @db.NVarChar(Max)
  
  // 응답 정보
  responseStatus  Int?
  responseBody    String?  @db.NVarChar(Max)
  responseTime    Int?     // 응답 시간 (ms)
  
  // 상태
  status          String   @db.NVarChar(50) // SUCCESS, FAILED
  errorMessage    String?  @db.NVarChar(Max)
  
  createdAt       DateTime @default(now())
  
  webhook         Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@index([webhookId])
  @@index([createdAt])
  @@map("WebhookLogs")
}

// ============================================
// 분석 & 성과
// ============================================

/// 일별 성과 통계
model DailyAnalytics {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @db.Date // 통계 날짜
  
  // 구글 검색 노출
  googleImpressions Int      @default(0) // 구글 검색 노출 수
  googleClicks      Int      @default(0) // 구글 검색 클릭 수
  googleCtr         Float    @default(0) // 클릭률 (CTR)
  
  // 상품 통계
  totalProducts     Int      @default(0) // 총 상품 수
  activeProducts    Int      @default(0) // 활성 상품 수
  exposedProducts   Int      @default(0) // 구글 노출 상품 수
  
  // 트래픽 소스
  organicTraffic    Int      @default(0) // 자연 검색 트래픽
  directTraffic     Int      @default(0) // 직접 방문
  referralTraffic   Int      @default(0) // 추천 트래픽
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("DailyAnalytics")
}

/// 상품별 성과
/// ⚠️ TODO: Product ID가 BigInt로 변경되어 임시로 비활성화됨
/// 향후 productId를 BigInt로 변경하여 재활성화 필요
// model ProductAnalytics {
//   id              String   @id @default(uuid())
//   productId       BigInt
//   date            DateTime @db.Date
//   
//   // 구글 성과
//   impressions     Int      @default(0) // 노출 수
//   clicks          Int      @default(0) // 클릭 수
//   ctr             Float    @default(0) // 클릭률
//   
//   // 순위
//   avgPosition     Float?   // 평균 검색 순위
//   topKeyword      String?  @db.NVarChar(200) // 주요 키워드
//   
//   createdAt       DateTime @default(now())
//   updatedAt       DateTime @updatedAt
//   
//   product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
//   
//   @@unique([productId, date])
//   @@index([productId])
//   @@index([date])
//   @@map("ProductAnalytics")
// }

// ============================================
// Google Shopping 피드
// ============================================

/// 피드 설정
model FeedSettings {
  id                String   @id @default(uuid())
  userId            String   @unique
  
  // 피드 정보
  feedTitle         String   @db.NVarChar(200)
  feedDescription   String?  @db.NVarChar(500)
  feedUrl           String?  @db.NVarChar(500) // 생성된 피드 URL
  
  // 상점 정보
  storeUrl          String?  @db.NVarChar(500)
  storeName         String?  @db.NVarChar(200)
  
  // Google Merchant Center 정보
  merchantId        String?  @db.NVarChar(100)
  
  // 피드 옵션
  includeInactive   Boolean  @default(false) // 비활성 상품 포함
  autoUpdate        Boolean  @default(true)  // 자동 업데이트
  updateFrequency   Int      @default(24)    // 업데이트 주기 (시간)
  
  // 통계
  lastGenerated     DateTime?
  totalProducts     Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("FeedSettings")
}

// ============================================
// 네이버 카테고리 시스템 (DDRo 기준)
// ============================================

/// 네이버 카테고리 정보
model NaverCategory {
  id                BigInt    @id @default(autoincrement())
  category_1        String?   @db.NVarChar(100)
  category_2        String?   @db.NVarChar(100)
  category_3        String?   @db.NVarChar(100)
  cid               String?   @db.NVarChar(50)
  created_at        DateTime? @default(now())
  
  @@map("NaverCategories")
  @@index([cid])
}

/// 네이버 수집 진행 상태
model NaverCollectionProgress {
  id                BigInt    @id @default(autoincrement())
  cid               String?   @db.NVarChar(50)
  category_1        String?   @db.NVarChar(100)
  category_2        String?   @db.NVarChar(100)
  category_3        String?   @db.NVarChar(100)
  collection_type   String?   @db.NVarChar(20)
  status            String?   @db.NVarChar(20)
  started_at        DateTime?
  completed_at      DateTime?
  error_message     String?   @db.NVarChar(500)
  retry_count       Int?      @default(0)
  created_at        DateTime? @default(now())
  updated_at        DateTime? @default(now())
  
  @@map("NaverCollectionProgress")
}

/// 네이버 쇼핑 키워드
model NaverShoppingKeyword {
  id                BigInt    @id @default(autoincrement())
  category_1        String?   @db.NVarChar(100)
  category_2        String?   @db.NVarChar(100)
  category_3        String?   @db.NVarChar(100)
  cid               String?   @db.NVarChar(50)
  rank              Int?
  keyword           String?   @db.NVarChar(200)
  collected_date    DateTime? @db.Date
  start_date        DateTime? @db.Date
  end_date          DateTime? @db.Date
  status            String?   @default("completed") @db.NVarChar(20)
  updated_at        DateTime? @default(now())
  brandlistin       Int?
  brandlitin        Int?
  
  @@map("NaverShoppingKeywords")
  @@index([cid])
  @@index([keyword])
}

// ============================================
// 고객 지원 시스템
// ============================================

/// FAQ 관리
model FAQ {
  id          String   @id @default(uuid())
  category    String   @db.NVarChar(100) // 카테고리 (사용법, 요금, 기술지원, 기타)
  question    String   @db.NVarChar(500)
  answer      String   @db.NVarChar(Max)
  isPublic    Boolean  @default(true)
  sortOrder   Int      @default(0)
  viewCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isPublic])
  @@index([sortOrder])
  @@map("FAQs")
}

/// 공지사항
model Announcement {
  id          String    @id @default(uuid())
  title       String    @db.NVarChar(200)
  content     String    @db.NVarChar(Max)
  isPinned    Boolean   @default(false)
  isPublic    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  viewCount   Int       @default(0)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([isPinned])
  @@index([isPublic])
  @@index([createdAt])
  @@map("Announcements")
}

/// 문의 답변
model InquiryResponse {
  id          String   @id @default(uuid())
  inquiryId   Int
  adminId     String   @db.NVarChar(450)
  adminName   String   @db.NVarChar(100)
  response    String   @db.NVarChar(Max)
  
  createdAt   DateTime @default(now())
  
  inquiry     IRInquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  
  @@index([inquiryId])
  @@map("InquiryResponses")
}

// ============================================
// 알림 시스템
// ============================================

/// 관리자 알림
model AdminNotification {
  id          String   @id @default(uuid())
  type        String   @db.NVarChar(50) // SYSTEM, SYNC, PAYMENT, PLAN, INQUIRY
  title       String   @db.NVarChar(200)
  message     String   @db.NVarChar(1000)
  severity    String   @db.NVarChar(20) // INFO, WARNING, ERROR
  isRead      Boolean  @default(false)
  link        String?  @db.NVarChar(500)
  metadata    String?  @db.NVarChar(Max) // JSON
  
  createdAt   DateTime @default(now())
  
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("AdminNotifications")
}

/// 알림 설정
model NotificationSettings {
  id                    String  @id @default(uuid())
  
  // 알림 활성화 여부
  syncFailureEnabled    Boolean @default(true)
  paymentFailureEnabled Boolean @default(true)
  planExpiryEnabled     Boolean @default(true)
  inquiryEnabled        Boolean @default(true)
  
  // 이메일 알림
  emailEnabled          Boolean @default(false)
  emailAddress          String? @db.NVarChar(255)
  
  // 웹훅 연동
  slackWebhook          String? @db.NVarChar(500)
  discordWebhook        String? @db.NVarChar(500)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("NotificationSettings")
}
